<?xml version="1.0" encoding="utf-8"?>

<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Sozeris.Pages.UserProfilePage"
             BackgroundColor="#F0EFEA">
    
    <ContentPage.Content>
        
        <Grid Padding="24">

            <ScrollView>
                <VerticalStackLayout Spacing="24">

                    <Label Text="Профиль"
                           FontSize="28"
                           FontAttributes="Bold"
                           TextColor="#2C1B12"
                           HorizontalOptions="Center" />

                    <!-- Информация пользователя -->
                    <Frame BackgroundColor="#FAFAF8"
                           CornerRadius="16"
                           Padding="20"
                           HasShadow="True">

                        <VerticalStackLayout Spacing="12">
                            <Label Text="{Binding User.Login}"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="#333" />

                            <Label Text="{Binding User.Address}"
                                   FontSize="16"
                                   TextColor="#666" />
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Кнопки меню -->
                    <VerticalStackLayout Spacing="16">

                        <Button Text="Изменить адрес доставки"
                                FontSize="16"
                                CornerRadius="12"
                                BackgroundColor="White"
                                TextColor="#2C1B12"
                                Command="{Binding AddressTappedCommand}" />

                        <Button Text="История покупок"
                                FontSize="16"
                                CornerRadius="12"
                                BackgroundColor="White"
                                TextColor="#2C1B12"
                                Command="{Binding SubscriptionHistoryTappedCommand}" />

                        <BoxView HeightRequest="1" Color="#DDD" />

                        <Button Text="Выйти"
                                FontSize="16"
                                CornerRadius="12"
                                BackgroundColor="#D67A33"
                                TextColor="White"
                                Command="{Binding LogoutCommand}" />
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </ScrollView>

            <!-- Всплывающее окно редактирования адреса -->
            <ContentView IsVisible="{Binding IsEditingAddress}"
                         BackgroundColor="#00000040"
                         Padding="20"
                         InputTransparent="False">

                <Grid HorizontalOptions="Center"
                      VerticalOptions="Center">

                    <Frame BackgroundColor="White"
                           CornerRadius="20"
                           Padding="20"
                           WidthRequest="300"
                           HasShadow="True">

                        <VerticalStackLayout Spacing="16">

                            <Label Text="Изменение адреса"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="#333"
                                   HorizontalOptions="Center" />

                            <Entry Placeholder="Введите новый адрес"
                                   Text="{Binding EditableAddress}"
                                   FontSize="16"
                                   TextColor="#333"
                                   BackgroundColor="#F0F0F0"
                                   HeightRequest="40"/>

                            <HorizontalStackLayout Spacing="12"
                                                   HorizontalOptions="End">
                                <Button Text="Отмена"
                                        Command="{Binding CancelEditAddressCommand}"
                                        BackgroundColor="#CCCCCC"
                                        TextColor="#333"
                                        CornerRadius="10"
                                        WidthRequest="100" />

                                <Button Text="Сохранить"
                                        Command="{Binding SaveAddressCommand}"
                                        BackgroundColor="#D67A33"
                                        TextColor="White"
                                        CornerRadius="10"
                                        WidthRequest="100" />
                            </HorizontalStackLayout>
                        </VerticalStackLayout>

                    </Frame>
                </Grid>
            </ContentView>

            <!-- Всплывающее окно истории покупок -->
            <ContentView IsVisible="{Binding IsSubscriptionHistoryVisible}"
                         BackgroundColor="#00000040"
                         Padding="20"
                         InputTransparent="False">

                <Grid>
                    <Frame BackgroundColor="White"
                           CornerRadius="20"
                           Padding="20"
                           HasShadow="True"
                           VerticalOptions="Center"
                           HorizontalOptions="Center"
                           MaximumWidthRequest="600">

                        <Grid RowSpacing="12">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                            </Grid.RowDefinitions>

                            <!-- Заголовок -->
                            <Grid>
                                <Label Text="История покупок"
                                       FontSize="20"
                                       FontAttributes="Bold"
                                       TextColor="#333"
                                       HorizontalOptions="Center"
                                       HorizontalTextAlignment="Center" />

                                <Button Text="✕"
                                        Command="{Binding CloseSubscriptionHistoryCommand}"
                                        BackgroundColor="Transparent"
                                        TextColor="#333"
                                        FontSize="18"
                                        HorizontalOptions="End"
                                        VerticalOptions="Start"/>
                            </Grid>

                            <!-- Прокручиваемая часть -->
                            <ScrollView Grid.Row="1">
                                <VerticalStackLayout Spacing="20">
                                    <CollectionView ItemsSource="{Binding Subscriptions}"
                                                    Margin="0">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Frame BackgroundColor="#F9F9F9"
                                                       CornerRadius="12"
                                                       Padding="14"
                                                       Margin="0,0,0,10"
                                                       HasShadow="False">

                                                    <VerticalStackLayout Spacing="8">
                                                        <!-- Заголовок подписки -->
                                                        <Label Text="{Binding Id, StringFormat='Подписка №{0}'}"
                                                               FontSize="15"
                                                               FontAttributes="Bold"
                                                               TextColor="#2C1B12" />

                                                        <Label FontSize="13"
                                                               TextColor="#444">
                                                            <Label.FormattedText>
                                                                <FormattedString>
                                                                    <Span Text="{Binding StartDate, StringFormat='с {0:dd.MM.yyyy}'}"/>
                                                                    <Span Text=" по " />
                                                                    <Span Text="{Binding EndDate, StringFormat='{0:dd.MM.yyyy}'}"/>
                                                                </FormattedString>
                                                            </Label.FormattedText>
                                                        </Label>

                                                        <Label Text="{Binding Price, StringFormat='Итого: {0} ₽'}"
                                                               FontSize="14"
                                                               FontAttributes="Bold"
                                                               TextColor="#D67A33" />

                                                        <!-- Список заказов -->
                                                        <CollectionView ItemsSource="{Binding Orders}"
                                                                        Margin="0">
                                                            <CollectionView.ItemTemplate>
                                                                <DataTemplate>
                                                                    <Frame BackgroundColor="White"
                                                                           CornerRadius="8"
                                                                           Padding="10"
                                                                           Margin="0,5,0,0"
                                                                           HasShadow="False">

                                                                        <VerticalStackLayout Spacing="4">
                                                                            <Label Text="{Binding Product.Name}"
                                                                                   FontSize="13"
                                                                                   FontAttributes="Bold"
                                                                                   TextColor="#333"/>

                                                                            <HorizontalStackLayout Spacing="10">
                                                                                <Label Text="{Binding Quantity, StringFormat='Кол-во: {0}'}"
                                                                                       FontSize="12"
                                                                                       TextColor="#666"/>
                                                                                <Label Text="{Binding Price, StringFormat='Сумма: {0} ₽'}"
                                                                                       FontSize="12"
                                                                                       TextColor="#666"/>
                                                                            </HorizontalStackLayout>
                                                                        </VerticalStackLayout>
                                                                    </Frame>
                                                                </DataTemplate>
                                                            </CollectionView.ItemTemplate>
                                                        </CollectionView>

                                                    </VerticalStackLayout>
                                                </Frame>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>
                            </ScrollView>
                        </Grid>
                    </Frame>
                </Grid>
            </ContentView>
        </Grid>
        
    </ContentPage.Content>
</ContentPage>