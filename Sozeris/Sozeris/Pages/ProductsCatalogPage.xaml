<?xml version="1.0" encoding="utf-8"?>

<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Sozeris.Pages.ProductsCatalogPage"
             BackgroundColor="#F0EFEA">

    <Grid Padding="24">

        <ScrollView>
            <VerticalStackLayout Spacing="30">

                <Label Text="Выберите состав корзины для подписки"
                       FontSize="24"
                       FontAttributes="Bold"
                       TextColor="#4A4A4A"
                       HorizontalOptions="Center"
                       Margin="0,0,0,5"/>

                <CollectionView x:Name="ProductList" 
                                ItemsSource="{Binding Products}" 
                                VerticalOptions="FillAndExpand">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Vertical" ItemSpacing="20" />
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame BackgroundColor="#FFFFFF"
                               CornerRadius="16"
                               Padding="10"
                               HasShadow="False"
                               BorderColor="Transparent">

                                <HorizontalStackLayout Spacing="10" VerticalOptions="Center" HorizontalOptions="FillAndExpand">

                                    <Frame CornerRadius="16"
                                           Padding="0"
                                           HasShadow="False"
                                           IsClippedToBounds="True"
                                           VerticalOptions="Center"
                                           WidthRequest="80"
                                           HeightRequest="80">

                                        <Image Source="{Binding Image}"
                                               Aspect="AspectFill"
                                               VerticalOptions="FillAndExpand"
                                               HorizontalOptions="FillAndExpand" />
                                    </Frame>

                                    <VerticalStackLayout Spacing="8" VerticalOptions="Center" HorizontalOptions="FillAndExpand">

                                        <Label Text="{Binding Name}"
                                               FontSize="18"
                                               FontAttributes="Bold"
                                               TextColor="#2C2C2C"
                                               LineBreakMode="TailTruncation" />

                                        <Label Text="{Binding Price, StringFormat='{}{0} ₽ / шт'}"
                                               FontSize="14"
                                               TextColor="#7A7A7A" />

                                        <HorizontalStackLayout Spacing="12" HorizontalOptions="FillAndExpand">
                                            <Grid ColumnDefinitions="*,*"
                                                  ColumnSpacing="12"
                                                  HorizontalOptions="FillAndExpand"
                                                  VerticalOptions="Center">
                                                <Button Grid.Column="0"
                                                        Text="Состав"
                                                        BackgroundColor="#CCCCCC"
                                                        TextColor="#4A4A4A"
                                                        CornerRadius="8"
                                                        HeightRequest="26"
                                                        WidthRequest="100"
                                                        HorizontalOptions="FillAndExpand"
                                                        Command="{Binding BindingContext.ShowCompositionCommand, Source={x:Reference ProductList}}"
                                                        CommandParameter="{Binding}" />

                                                <Button Grid.Column="1"
                                                        Text="Добавить"
                                                        BackgroundColor="#D67A33"
                                                        TextColor="White"
                                                        CornerRadius="8"
                                                        HeightRequest="26"
                                                        WidthRequest="100"
                                                        HorizontalOptions="FillAndExpand"
                                                        Command="{Binding BindingContext.AddCommand, Source={x:Reference ProductList}}"
                                                        CommandParameter="{Binding}" />
                                            </Grid>
                                        </HorizontalStackLayout>

                                    </VerticalStackLayout>

                                </HorizontalStackLayout>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

            </VerticalStackLayout>
        </ScrollView>

        <!-- Всплывающее окно выбора количества -->
        <ContentView IsVisible="{Binding IsPopupVisible}"
                     BackgroundColor="#00000080"
                     Padding="10">

            <Frame BackgroundColor="#fffbe6"
                   CornerRadius="20"
                   Padding="0"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   WidthRequest="300">

                <Grid>
                    <!-- 2 строки: одна под крестик, вторая — всё остальное -->
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!-- Кнопка закрытия -->
                    <Button Text="✕"
                            FontSize="18"
                            BackgroundColor="Transparent"
                            TextColor="#333"
                            HorizontalOptions="End"
                            VerticalOptions="Start"
                            WidthRequest="40"
                            HeightRequest="40"
                            Command="{Binding ClosePopupCommand}"
                            Padding="0"
                            Margin="5"/>

                    <!-- Содержимое попапа -->
                    <VerticalStackLayout Grid.Row="1" Spacing="15" Padding="20">

                        <Label Text="{Binding SelectedProduct.Name}"
                               FontSize="20"
                               FontAttributes="Bold"
                               HorizontalOptions="Center"
                               TextColor="#333"/>

                        <HorizontalStackLayout HorizontalOptions="Center" Spacing="15">
                            <Button Text="−" WidthRequest="40" Command="{Binding DecreaseCommand}"/>
                            <Label Text="{Binding Quantity}" FontSize="18" TextColor="#333" VerticalOptions="Center"/>
                            <Button Text="+" WidthRequest="40" Command="{Binding IncreaseCommand}"/>
                        </HorizontalStackLayout>

                        <Button Text="Подтвердить"
                                BackgroundColor="#D97A29"
                                TextColor="White"
                                CornerRadius="8"
                                HeightRequest="45"
                                Command="{Binding ConfirmCommand}"/>
                    </VerticalStackLayout>
                </Grid>
            </Frame>
            
        </ContentView>

        <!-- Всплывающее уведомление (toast) -->
        <ContentView IsVisible="{Binding IsToastVisible}"
                     BackgroundColor="#00000040"
                     HorizontalOptions="FillAndExpand"
                     VerticalOptions="FillAndExpand"
                     Padding="24"
                     InputTransparent="False">

            <Grid HorizontalOptions="Center"
                  VerticalOptions="Center">

                <Frame BackgroundColor="White"
                       CornerRadius="20"
                       Padding="25"
                       HasShadow="True"
                       WidthRequest="320">

                    <VerticalStackLayout HorizontalOptions="Center"
                                         VerticalOptions="Center"
                                         Spacing="15">

                        <Label Text="Добавлено"
                               FontSize="20"
                               FontAttributes="Bold"
                               TextColor="#333"
                               HorizontalOptions="Center" />

                        <Label Text="{Binding ToastText}"
                               FontSize="16"
                               TextColor="#777"
                               HorizontalTextAlignment="Center"
                               HorizontalOptions="Center" />
                    </VerticalStackLayout>
                </Frame>
            </Grid>
        </ContentView>

    </Grid>
</ContentPage>